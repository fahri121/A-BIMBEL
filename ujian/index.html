<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CBT Sekolah</title>

<style>
body{font-family:Arial;background:#eef2f7;padding:20px}
.box{max-width:600px;margin:auto;background:#fff;padding:20px;border-radius:10px}
button{padding:10px;width:100%;margin-top:10px}
#timer{color:red;font-weight:bold}
</style>
</head>

<body>

<div class="box" id="login">
<h2>Login Ujian</h2>
<input id="nama" placeholder="Nama siswa" style="width:100%;padding:10px"><br><br>
<button onclick="mulai()">Mulai</button>
</div>

<div class="box" id="ujian" style="display:none">

<div id="timer"></div>
<h3 id="soal"></h3>
<div id="opsi"></div>

<button onclick="next()">Next</button>

</div>

<div class="box" id="hasil" style="display:none">
<h2>Selesai</h2>
<p id="nilai"></p>
</div>

<script>

let waktu=300;
let timer;

let soal=[];
let MAPEL="IPA"; // ganti mapel

let i=0,score=0,nama="";

fetch("https://docs.google.com/spreadsheets/d/1QnQS13-jb5lwx7VdbcdvxAWaYmsx1G55zy2Yo5r7AJY/edit?usp=sharing")
.then(r=>r.text())
.then(t=>{

let rows=t.split("<tr>").slice(1);

rows.forEach(r=>{
let c=r.split("<td>");

if(c.length>7 && c[1].includes(MAPEL)){

soal.push({
q:c[2].split("</td>")[0],
img:c[3].split("</td>")[0],
a:[
c[4].split("</td>")[0],
c[5].split("</td>")[0],
c[6].split("</td>")[0],
c[7].split("</td>")[0]
],
k:["A","B","C","D"].indexOf(c[8].split("</td>")[0].trim())
});

}

});

soal.sort(()=>Math.random()-0.5);
load();

});

function mulai(){
nama=document.getElementById("nama").value;
if(!nama) return alert("Isi nama!");

document.documentElement.requestFullscreen();

document.getElementById("login").style.display="none";
document.getElementById("ujian").style.display="block";

timer=setInterval(countdown,1000);
load();
}

function countdown(){
waktu--;
document.getElementById("timer").innerHTML="Sisa waktu: "+waktu+" detik";

if(waktu<=0){
selesai();
}
}

function load(){

let s=soal[i];

let img = s.img ? `<img src="${s.img}" style="max-width:100%"><br>` : "";

document.getElementById("soal").innerHTML=img+s.q;

let h="";
s.a.forEach((x,n)=>{
h+=`<label><input type=radio name=j value=${n}> ${x}</label><br>`;
});

document.getElementById("opsi").innerHTML=h;
}
  
let h="";
soal[i].a.forEach((x,n)=>{
h+=`<label><input type=radio name=j value=${n}> ${x}</label><br>`;
});
document.getElementById("opsi").innerHTML=h;
}

function next(){
let j=document.querySelector('input[name=j]:checked');
if(j && j.value==soal[i].k) score++;

i++;
if(i<soal.length) load();
else selesai();
}

function selesai(){
  clearInterval(timer);

  let nilai = Math.round(score/soal.length*100);

  // kirim ke Google Form
  fetch("https://docs.google.com/forms/d/e/1FAIpQLSe72_R-ebHIiLzmRMBIMUlGRFaGCd9bVdMd3iBTO7Ppj8WDZg/formResponse", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `entry.1077864679=${nama}&entry.1981506209=${nilai}`
  });

  document.getElementById("ujian").style.display = "none";
  document.getElementById("hasil").style.display = "block";
  document.getElementById("nilai").innerHTML = "Nilai "+nama+": "+nilai;
}
  
document.addEventListener("visibilitychange",()=>{
if(document.hidden) alert("Jangan keluar ujian!");
});

</script>

</body>
</html>


