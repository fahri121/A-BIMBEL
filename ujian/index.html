<script>

let waktu = 300, timer;
let soal = [], SISWA = [];
let MAPEL = "IPA";
let i = 0, score = 0, nama = "";

/* === AMBIL BANK SOAL === */
fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vSq78zEvEu82Qh8uTNuVDgfeY3FxA09wrjWI00c3no6hPvT0twucsTpB94-hGq1oxY77R6huXF4HGfr/pubhtml")
.then(r => r.text())
.then(t => {
  let rows = t.split("<tr>").slice(1);
  rows.forEach(row => {
    let c = row.split("<td>");
    if (c.length > 8 && c[1].includes(MAPEL)) {
      soal.push({
        q: c[2].replace(/<[^>]*>/g, '').trim(),
        img: c[3].replace(/<[^>]*>/g, '').trim(),
        a: [
          c[4].replace(/<[^>]*>/g, '').trim(),
          c[5].replace(/<[^>]*>/g, '').trim(),
          c[6].replace(/<[^>]*>/g, '').trim(),
          c[7].replace(/<[^>]*>/g, '').trim()
        ],
        k: ["A", "B", "C", "D"].indexOf(c[8].replace(/<[^>]*>/g, '').trim())
      });
    }
  });
  soal.sort(() => Math.random() - 0.5);
});

/* === AMBIL DATA SISWA === */
fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRzq_BK4My4MJkNKZ5GmithzEiXnr2J3oQuK5jFoBAPK1V9OMGP8gf3sof0JzEPNxLBk86ekz2su-2Q/pubhtml")
.then(r => r.text())
.then(t => {
  let rows = t.split("<tr>").slice(1);
  rows.forEach(row => {
    let c = row.split("<td>");
    if (c.length > 2) {
      SISWA.push({
        nis: c[1].replace(/<[^>]*>/g, '').trim(),
        nama: c[2].replace(/<[^>]*>/g, '').trim()
      });
    }
  });
});

/* === LOGIN SISWA === */
function login() {
  let nisInput = document.getElementById("nis").value.trim();
  let namaInput = document.getElementById("nama").value.trim();

  if (!nisInput || !namaInput) {
    return alert("Masukkan NIS dan Nama siswa!");
  }

  let valid = SISWA.find(s => s.nis === nisInput && s.nama.toLowerCase() === namaInput.toLowerCase());
  if (!valid) {
    return alert("NIS atau Nama tidak terdaftar!");
  }

  nama = valid.nama;

  document.getElementById("login").style.display = "none";
  document.getElementById("ujian").style.display = "block";

  document.documentElement.requestFullscreen();
  timer = setInterval(countdown, 1000);
  load();
}

/* === TIMER === */
function countdown() {
  waktu--;
  document.getElementById("timer").innerText = "Sisa waktu: " + waktu + " detik";
  if (waktu <= 0) selesai();
}

/* === TAMPILKAN SOAL === */
function load() {
  let s = soal[i];
  if (!s) return;

  let imgHTML = s.img ? `<img src="${s.img}" style="max-width:100%; margin-bottom:10px;">` : "";
  document.getElementById("soal").innerHTML = imgHTML + s.q;

  let html = "";
  s.a.forEach((opsi, idx) => {
    html += `<label><input type="radio" name="jawab" value="${idx}"> ${opsi}</label><br>`;
  });

  document.getElementById("opsi").innerHTML = html;
}

/* === NEXT SOAL === */
function next() {
  let selected = document.querySelector('input[name="jawab"]:checked');
  if (selected && parseInt(selected.value) === soal[i].k) {
    score++;
  }

  i++;
  if (i < soal.length) {
    load();
  } else {
    selesai();
  }
}

/* === SELESAI UJIAN === */
function selesai() {
  clearInterval(timer);

  let finalScore = Math.round(score / soal.length * 100);

  fetch("https://docs.google.com/forms/d/e/1FAIpQLSe72_R-ebHIiLzmRMBIMUlGRFaGCd9bVdMd3iBTO7Ppj8WDZg/formResponse", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `entry.1077864679=${encodeURIComponent(nama)}&entry.1981506209=${finalScore}`
  });

  document.getElementById("ujian").style.display = "none";
  document.getElementById("hasil").style.display = "block";
  document.getElementById("nilai").innerText = "Nilai " + nama + ": " + finalScore;
}

</script>
